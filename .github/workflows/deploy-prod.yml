name: Deploy Prod (meer_prod)

on:
  push:
    branches: [ main ]

jobs:
  migrate-and-deploy:
    concurrency:
      group: deploy-prod
      cancel-in-progress: true
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decode and load env from base64 secret
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${{ secrets.PROD_ENV_FILE_B64 }}" ]; then
            echo "Missing required secret: PROD_ENV_FILE_B64" >&2
            exit 1
          fi

          echo "${{ secrets.PROD_ENV_FILE_B64 }}" | tr -d '\r\n\t ' | base64 --decode > .env
          cat >> .env <<'EOF'
          FIREBASE_ENABLED=true
          FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CREDENTIALS_PATH=/opt/meer-prod/firebase-service-account.json
          EOF

          while IFS= read -r line || [ -n "$line" ]; do
            line="${line#"${line%%[![:space:]]*}"}"
            line="${line%"${line##*[![:space:]]}"}"

            [ -z "$line" ] && continue
            case "$line" in
              \#*) continue ;;
            esac

            case "$line" in
              *=*)
                key="${line%%=*}"
                val="${line#*=}"
                key="${key#"${key%%[![:space:]]*}"}"
                key="${key%"${key##*[![:space:]]}"}"
                printf '%s=%s\n' "$key" "$val" >> "$GITHUB_ENV"
                ;;
              *)
                echo "Invalid line in decoded env file: $line" >&2
                exit 1
                ;;
            esac
          done < .env

      - name: Fail if required vars are missing
        shell: bash
        run: |
          set -euo pipefail
          required=(
            DB_HOST DB_PORT DB_NAME DB_USER DB_PASSWORD
            SPRING_PROFILES_ACTIVE
            SECURITY_JWT_SECRET SECURITY_JWT_ACCESS_TTL_MINUTES SECURITY_JWT_REFRESH_TTL_DAYS
            GOOGLE_ANDROID_CLIENT_ID GOOGLE_IOS_CLIENT_ID GOOGLE_WEB_CLIENT_ID
            GOOGLE_APPLICATION_CREDENTIALS
            FIREBASE_ENABLED FIREBASE_PROJECT_ID FIREBASE_CREDENTIALS_PATH
            GCS_BUCKET GCS_PUBLIC_BASE_URL GCS_SIGNED_URL_TTL_MINUTES GCS_AVATARS_PREFIX
            MEER_CORS_ALLOWED_ORIGINS
            SERVICE REMOTE_JAR HEALTH_URL
          )

          missing=()
          for k in "${required[@]}"; do
            v="$(printenv "$k" || true)"
            [ -n "$v" ] || missing+=("$k")
          done

          if [ ${#missing[@]} -ne 0 ]; then
            echo "Missing required vars: ${missing[*]}" >&2
            exit 1
          fi

      - name: Set build version
        run: echo "SHA_SHORT=${GITHUB_SHA::7}" >> "$GITHUB_ENV"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Pre-cleanup disk on prod host (before Flyway)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            sudo apt-get clean || true
            sudo rm -rf /root/.gradle/caches /root/.gradle/wrapper || true
            sudo find /tmp -mindepth 1 -mtime +1 -exec rm -rf {} + || true
            sudo journalctl --vacuum-time=7d --vacuum-size=100M || true
            sudo logrotate -f /etc/logrotate.conf || true
            sudo gzip -f /var/log/syslog.1 2>/dev/null || true
            df -h / /tmp /var || true

      - name: Run Flyway migrations on prod DB
        run: ./gradlew :springboot:flywayMigrate

      - name: Flyway info (out-of-order check)
        run: ./gradlew :springboot:flywayInfo

      - name: Build jar
        run: ./gradlew :springboot:bootJar

      - name: Rename jar with version
        run: mv springboot/build/libs/meer-*.jar springboot/build/libs/meer-${{ env.SHA_SHORT }}.jar

      - name: Cleanup old backups and tmp on prod host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            sudo rm -rf /opt/meer-prod/meer.jar.bak.* /tmp/meer-*.jar /tmp/.env /tmp/.env/.env || true
            sudo apt-get clean || true
            sudo journalctl --vacuum-time=7d --vacuum-size=100M || true
            sudo logrotate -f /etc/logrotate.conf || true
            sudo gzip -f /var/log/syslog.1 2>/dev/null || true
            df -h / /tmp /var || true

      - name: Copy jar to prod host
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: springboot/build/libs/meer-${{ env.SHA_SHORT }}.jar
          target: /tmp
          strip_components: 3

      - name: Copy runtime .env to prod host
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: .env
          target: /tmp

      - name: Restart service on prod
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            
            # Ensure the runtime env file is in place first
            if [ -f /tmp/.env ]; then
              sudo mv /tmp/.env /opt/meer-prod/.env
              sudo chown meerprod:meerprod /opt/meer-prod/.env
              sudo chmod 600 /opt/meer-prod/.env
            fi

            # Backup current jar
            if [ -f "${{ env.REMOTE_JAR }}" ]; then
              sudo cp "${{ env.REMOTE_JAR }}" "${{ env.REMOTE_JAR }}.bak"
            fi

            # Deploy new jar
            sudo mv "/tmp/meer-${{ env.SHA_SHORT }}.jar" "${{ env.REMOTE_JAR }}"
            sudo chown meerprod:meerprod "${{ env.REMOTE_JAR }}"
            
            # Source env locally for this script (needed for GOOGLE_APPLICATION_CREDENTIALS, etc.)
            if sudo test -f /opt/meer-prod/.env; then
              set -a
              # shellcheck disable=SC1091
              source <(sudo cat /opt/meer-prod/.env)
              set +a
            fi

            # Ensure systemd loads env vars from /opt/meer-prod/.env on restart
            sudo mkdir -p /etc/systemd/system/"${{ env.SERVICE }}".service.d
            sudo tee /etc/systemd/system/"${{ env.SERVICE }}".service.d/env.conf >/dev/null <<'EOF'
            [Service]
            EnvironmentFile=/opt/meer-prod/.env
            EOF
            sudo systemctl daemon-reload
            
            cred_path="${GOOGLE_APPLICATION_CREDENTIALS:-}"
            if [ -z "$cred_path" ]; then
              echo "GOOGLE_APPLICATION_CREDENTIALS not set (checked /opt/meer-prod/.env and env var)" >&2
              exit 1
            fi
            if [ "${cred_path#/}" = "$cred_path" ]; then
              cred_path="/opt/meer-prod/$cred_path"
            fi
            if [ "${cred_path%/}" != "$cred_path" ]; then
              cred_path="${cred_path}service-account.json"
            fi
            
            if [ -z "${{ secrets.GCP_SA_B64 }}" ]; then
              echo "Missing secret GCP_SA_B64" >&2
              exit 1
            fi
            
            sudo mkdir -p "$(dirname "$cred_path")"
            echo "${{ secrets.GCP_SA_B64 }}" | tr -d '\r\n\t ' | base64 --decode | sudo tee "$cred_path" >/dev/null
            sudo chown meerprod:meerprod "$cred_path"
            sudo chmod 600 "$cred_path"
            sudo test -s "$cred_path" || { echo "Failed to write credentials to $cred_path" >&2; exit 1; }

            firebase_cred_path="${FIREBASE_CREDENTIALS_PATH:-}"
            if [ -z "$firebase_cred_path" ]; then
              echo "FIREBASE_CREDENTIALS_PATH not set (checked /opt/meer-prod/.env and env var)" >&2
              exit 1
            fi
            if [ "${firebase_cred_path#/}" = "$firebase_cred_path" ]; then
              firebase_cred_path="/opt/meer-prod/$firebase_cred_path"
            fi
            if [ "${firebase_cred_path%/}" != "$firebase_cred_path" ]; then
              firebase_cred_path="${firebase_cred_path}firebase-service-account.json"
            fi

            if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON_B64 }}" ]; then
              echo "Missing secret FIREBASE_SERVICE_ACCOUNT_JSON_B64" >&2
              exit 1
            fi

            sudo mkdir -p "$(dirname "$firebase_cred_path")"
            echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON_B64 }}" | tr -d '\r\n\t ' | base64 --decode | sudo tee "$firebase_cred_path" >/dev/null
            sudo chown meerprod:meerprod "$firebase_cred_path"
            sudo chmod 600 "$firebase_cred_path"
            sudo test -s "$firebase_cred_path" || { echo "Failed to write Firebase credentials to $firebase_cred_path" >&2; exit 1; }

            sudo systemctl restart "${{ env.SERVICE }}"

      - name: Cleanup temp artifacts on prod host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            sudo rm -f /tmp/meer-*.jar /tmp/.env /tmp/.env/.env || true

      - name: Smoke test (health)
        if: ${{ success() }}
        run: |
          for i in {1..40}; do
            status=$(curl -sSL -o /tmp/health.json -w "%{http_code}" "${{ env.HEALTH_URL }}") || true
            if [ "$status" = "200" ] && grep -q '"status"[[:space:]]*:[[:space:]]*"UP"' /tmp/health.json; then
              cat /tmp/health.json
              exit 0
            fi
            sleep 5
          done
          echo "Health check failed (status=$status)" >&2
          cat /tmp/health.json || true
          exit 1
