name: Deploy Prod (meer_prod)

on:
  push:
    branches: [ main ]

jobs:
  migrate-and-deploy:
    concurrency:
      group: deploy-prod
      cancel-in-progress: true
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decode and load env from base64 secret
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${{ secrets.PROD_ENV_FILE_B64 }}" ]; then
            echo "Missing required secret: PROD_ENV_FILE_B64" >&2
            exit 1
          fi

          echo "${{ secrets.PROD_ENV_FILE_B64 }}" | base64 --decode > runtime-prod.env
          chmod 600 runtime-prod.env

          # Export everything into job env for subsequent steps
          # - ignores blank lines and comments
          # - supports values containing '='
          while IFS= read -r line || [ -n "$line" ]; do
            line="${line#"${line%%[![:space:]]*}"}"
            line="${line%"${line##*[![:space:]]}"}"

            [ -z "$line" ] && continue
            case "$line" in
              \#*) continue ;;
            esac

            case "$line" in
              *=*)
                key="${line%%=*}"
                val="${line#*=}"
                key="${key#"${key%%[![:space:]]*}"}"
                key="${key%"${key##*[![:space:]]}"}"
                printf '%s=%s\n' "$key" "$val" >> "$GITHUB_ENV"
                ;;
              *)
                echo "Invalid line in decoded env file: $line" >&2
                exit 1
                ;;
            esac
          done < runtime-prod.env

      - name: Fail if required vars are missing
        shell: bash
        run: |
          set -euo pipefail
          required=(
            DB_HOST DB_PORT DB_NAME DB_USER DB_PASSWORD
            SPRING_PROFILES_ACTIVE
            SECURITY_JWT_SECRET SECURITY_JWT_ACCESS_TTL_MINUTES SECURITY_JWT_REFRESH_TTL_DAYS
            GOOGLE_ANDROID_CLIENT_ID GOOGLE_IOS_CLIENT_ID GOOGLE_WEB_CLIENT_ID
            GOOGLE_APPLICATION_CREDENTIALS
            GCS_BUCKET GCS_PUBLIC_BASE_URL GCS_SIGNED_URL_TTL_MINUTES GCS_AVATARS_PREFIX
            MEER_CORS_ALLOWED_ORIGINS
            SSH_HOST SSH_USER SSH_KEY
            SERVICE REMOTE_JAR HEALTH_URL
          )

          missing=()
          for k in "${required[@]}"; do
            v="$(printenv "$k" || true)"
            [ -n "$v" ] || missing+=("$k")
          done

          if [ ${#missing[@]} -ne 0 ]; then
            echo "Missing required vars: ${missing[*]}" >&2
            exit 1
          fi

      - name: Set build version
        run: echo "SHA_SHORT=${GITHUB_SHA::7}" >> "$GITHUB_ENV"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Run Flyway migrations on prod DB
        run: ./gradlew :springboot:flywayMigrate

      - name: Flyway info (out-of-order check)
        run: ./gradlew :springboot:flywayInfo

      - name: Build jar
        run: ./gradlew :springboot:bootJar

      - name: Rename jar with version
        run: mv springboot/build/libs/meer-*.jar springboot/build/libs/meer-${{ env.SHA_SHORT }}.jar

      - name: Cleanup old backups and tmp on prod host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            set -e
            sudo rm -rf /opt/meer-prod/meer.jar.bak.* /tmp/meer-prod-* || true
            sudo apt-get clean || true
            sudo journalctl --vacuum-time=7d --vacuum-size=100M || true
            sudo logrotate -f /etc/logrotate.conf || true
            sudo gzip -f /var/log/syslog.1 2>/dev/null || true
            df -h / /tmp /var || true

      - name: Copy jar to prod host
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          source: springboot/build/libs/meer-${{ env.SHA_SHORT }}.jar
          target: /tmp/meer-prod-${{ env.SHA_SHORT }}.jar
          strip_components: 3

      - name: Copy runtime .env to prod host
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          source: runtime-prod.env
          target: /tmp/runtime-prod.env

      - name: Restart service on prod
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            set -e

            if [ -f /tmp/runtime-prod.env ]; then
              sudo mv /tmp/runtime-prod.env /opt/meer-prod/.env
              sudo chown meerprod:meerprod /opt/meer-prod/.env
              sudo chmod 600 /opt/meer-prod/.env
            fi

            if [ -f "${{ env.REMOTE_JAR }}" ]; then
              sudo cp "${{ env.REMOTE_JAR }}" "${{ env.REMOTE_JAR }}.bak"
            fi

            sudo mv "/tmp/meer-prod-${{ env.SHA_SHORT }}.jar" "${{ env.REMOTE_JAR }}"
            sudo chown meerprod:meerprod "${{ env.REMOTE_JAR }}"
            sudo systemctl restart "${{ env.SERVICE }}"

      - name: Smoke test (health)
        if: ${{ success() }}
        run: |
          for i in {1..40}; do
            status=$(curl -sSL -o /tmp/health.json -w "%{http_code}" "${{ env.HEALTH_URL }}") || true
            if [ "$status" = "200" ] && grep -q '"status"[[:space:]]*:[[:space:]]*"UP"' /tmp/health.json; then
              cat /tmp/health.json
              exit 0
            fi
            sleep 5
          done
          echo "Health check failed (status=$status)" >&2
          cat /tmp/health.json || true
          exit 1
