name: ci-pr

on:
  pull_request:
  

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Decode and load env from base64 secret
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${{ secrets.CI_ENV_FILE_B64 }}" ]; then
            echo "Missing required secret: CI_ENV_FILE_B64" >&2
            exit 1
          fi

          echo "${{ secrets.CI_ENV_FILE_B64 }}" | tr -d '\r\n\t ' | base64 --decode > .env

          while IFS= read -r line || [ -n "$line" ]; do
            line="${line#"${line%%[![:space:]]*}"}"
            line="${line%"${line##*[![:space:]]}"}"

            [ -z "$line" ] && continue
            case "$line" in
              \#*) continue ;;
            esac

            case "$line" in
              *=*)
                key="${line%%=*}"
                val="${line#*=}"
                key="${key#"${key%%[![:space:]]*}"}"
                key="${key%"${key##*[![:space:]]}"}"
                printf '%s=%s\n' "$key" "$val" >> "$GITHUB_ENV"
                ;;
              *)
                echo "Invalid line in decoded env file: $line" >&2
                exit 1
                ;;
            esac
          done < .env

      - name: Fail if required vars are missing
        shell: bash
        run: |
          set -euo pipefail
          required=(
            DB_HOST DB_PORT DB_NAME DB_USER DB_PASSWORD
            SPRING_PROFILES_ACTIVE
            SECURITY_JWT_SECRET
          )

          missing=()
          for k in "${required[@]}"; do
            v="$(printenv "$k" || true)"
            [ -n "$v" ] || missing+=("$k")
          done

          if [ ${#missing[@]} -ne 0 ]; then
            echo "Missing required vars: ${missing[*]}" >&2
            exit 1
          fi
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle
      - name: Run fast tests
        run: ./gradlew :springboot:test
